---
name: DORA Metrics

on:
  workflow_dispatch:
    inputs:
      pipeline-config-file:
        description: "Pipeline configuration file to evaluate"
        required: false
        type: string
        default: "main-pipeline.yml"
      limit:
        description: "Workflow runs limit"
        required: false
        type: string
        default: "100"
      from-date:
        description: "Start date (YYYY-MM-DD format)"
        required: false
        type: string
        default: "7 days ago"
      to-date:
        description: "End date (YYYY-MM-DD format)"
        required: false
        type: string
        default: "today"

  schedule:
    - cron: "0 9 * * 2" # Every Tuesday at 09:00 UTC

jobs:
  dora-metrics:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Generate DORA Metrics and upload to repository
        working-directory: scripts/dora-metrics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PIPELINE_CONFIG_FILE: ${{ inputs.pipeline-config-file || 'main-pipeline.yml' }}
          LIMIT: ${{ inputs.limit || '100' }}
          RESULTS_DIR: results
          SCRIPT_FILE: generate_metrics.sh
          FROM: ${{ inputs.from-date || '7 days ago' }}
          TO: ${{ inputs.to-date || 'now' }}
        run: |
          FROM_DATE=$(date -u -d "$FROM" '+%Y-%m-%d')
          TO_DATE=$(date -u -d "$TO" '+%Y-%m-%d')
          echo "Analyzing workflow runs from $FROM_DATE to $TO_DATE"

          mkdir -p "${{ env.RESULTS_DIR }}"
          chmod +x "${{ env.SCRIPT_FILE }}"

          ./${{ env.SCRIPT_FILE }} \
            -w "${{ env.PIPELINE_CONFIG_FILE }}" \
            -l "${{ env.LIMIT }}" \
            -f "$FROM_DATE" \
            -t "$TO_DATE"

      - name: Calculate Metrics and Generate Report
        id: calculate_metrics
        working-directory: scripts/dora-metrics
        env:
          SCRIPT_FILE: generate_report.py
          METRICS_FILE: results/metrics-raw.md
          DORA_SUMMARY_FILE: docs/ci-cd/dora-summary.md
        run: |
          chmod +x "${{ env.SCRIPT_FILE }}"
          python3 "${{ env.SCRIPT_FILE }}" "${{ env.METRICS_FILE }}" \
            ../../"${{ env.DORA_SUMMARY_FILE }}" --gh \
            | tee -a $GITHUB_STEP_SUMMARY

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        env:
          DORA_SUMMARY_FILE: docs/ci-cd/dora-summary.md
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs(ci-cd): Update DORA metrics summary

            Overall Performance: ${{ steps.calculate_metrics.outputs.overall_performance }}

            Metrics:
            - Deployment Frequency: ${{ steps.calculate_metrics.outputs.deployment_frequency }}/week (${{ steps.calculate_metrics.outputs.deployment_frequency_class }})
            - Lead Time: ${{ steps.calculate_metrics.outputs.lead_time }} minutes (${{ steps.calculate_metrics.outputs.lead_time_class }})
            - Change Failure Rate: ${{ steps.calculate_metrics.outputs.change_failure_rate }}% (${{ steps.calculate_metrics.outputs.change_failure_rate_class }})
            - Time to Restore: ${{ steps.calculate_metrics.outputs.time_to_restore }} minutes (${{ steps.calculate_metrics.outputs.time_to_restore_class }})

            Statistics:
            - Total runs: ${{ steps.calculate_metrics.outputs.total_runs }}
            - Successful: ${{ steps.calculate_metrics.outputs.successful_runs }}
            - Failed: ${{ steps.calculate_metrics.outputs.failed_runs }}
            - Success Rate: ${{ steps.calculate_metrics.outputs.success_rate }}%
          branch: dora-metrics-update
          delete-branch: true
          title: "docs(ci-cd): Update DORA metrics summary"
          body: |
            ## DORA Metrics Update

            DORA metrics report has been generated and committed to the repository. Period: ${FROM} - ${TO}.
          labels: docs
          add-paths: ${{ env.DORA_SUMMARY_FILE }}

      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DEPLOYMENT_FREQUENCY: ${{ steps.calculate_metrics.outputs.deployment_frequency }}
          LEAD_TIME: ${{ steps.calculate_metrics.outputs.lead_time }}
          CHANGE_FAILURE_RATE: ${{ steps.calculate_metrics.outputs.change_failure_rate }}
          TIME_TO_RESTORE: ${{ steps.calculate_metrics.outputs.time_to_restore }}
          TOTAL_RUNS: ${{ steps.calculate_metrics.outputs.total_runs }}
          SUCCESSFUL_RUNS: ${{ steps.calculate_metrics.outputs.successful_runs }}
          FAILED_RUNS: ${{ steps.calculate_metrics.outputs.failed_runs }}
          SUCCESS_RATE: ${{ steps.calculate_metrics.outputs.success_rate }}
          DEPLOYMENT_FREQUENCY_CLASS: ${{ steps.calculate_metrics.outputs.deployment_frequency_class }}
          LEAD_TIME_CLASS: ${{ steps.calculate_metrics.outputs.lead_time_class }}
          CHANGE_FAILURE_RATE_CLASS: ${{ steps.calculate_metrics.outputs.change_failure_rate_class }}
          TIME_TO_RESTORE_CLASS: ${{ steps.calculate_metrics.outputs.time_to_restore_class }}
          OVERALL_PERFORMANCE: ${{ steps.calculate_metrics.outputs.overall_performance }}
          WORKFLOW_NAME: ${{ inputs.pipeline-config-file || 'main-pipeline.yml' }}
          WORKFLOW_URL: ${{ github.server_url }}/ukma-cs-ssdm-2025/rate-ukma/actions/workflows/dora.yml
          JOB_STATUS: ${{ job.status }}
          FROM: ${{ inputs.from-date || '7 days ago' }}
          TO: ${{ inputs.to-date || 'now' }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "Discord webhook URL not configured, skipping notification"
            exit 0
          fi

          if [ "$JOB_STATUS" = "success" ]; then
            COLOR=3066993  # Green
          else
            COLOR=15158332  # Red
          fi

          LEAD_TIME_MIN=$(echo "$LEAD_TIME" | cut -d. -f1)
          TTR_MIN=$(echo "$TIME_TO_RESTORE" | cut -d. -f1)
          SUCCESS_RATE_INT=$(echo "$SUCCESS_RATE" | cut -d. -f1)

          case "$OVERALL_PERFORMANCE" in
            "Elite")
              PERF_COLOR="Elite ‚≠ê‚≠ê‚≠ê‚≠ê"
              ;;
            "High")
              PERF_COLOR="High ‚≠ê‚≠ê‚≠ê"
              ;;
            "Medium")
              PERF_COLOR="Medium ‚≠ê‚≠ê"
              ;;
            *)
              PERF_COLOR="Low ‚≠ê"
              ;;
          esac

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "DORA Metrics Report Updated",
              "description": "**Overall Performance: ${PERF_COLOR}**\n\nDORA metrics report has been generated and committed to the repository. Period: ${FROM} - ${TO}.",
              "color": ${COLOR},
              "fields": [
                {
                  "name": "\nüì¶ Workflow",
                  "value": "\`${WORKFLOW_NAME}\`",
                  "inline": false
                },
                {
                  "name": "\nüìä Run Statistics",
                  "value": "**Total:** ${TOTAL_RUNS} | **Success:** ${SUCCESSFUL_RUNS} | **Failed:** ${FAILED_RUNS} \n**Success Rate:** ${SUCCESS_RATE_INT}%",
                  "inline": false
                },
                {
                  "name": "\nüöÄ Deployment Frequency",
                  "value": "**${DEPLOYMENT_FREQUENCY}/week**\n\`${DEPLOYMENT_FREQUENCY_CLASS} Performance\`",
                  "inline": true
                },
                {
                  "name": "\n‚è±Ô∏è Lead Time",
                  "value": "**${LEAD_TIME_MIN} minutes**\n\`${LEAD_TIME_CLASS} Performance\`",
                  "inline": true
                },
                {
                  "name": "\n‚ö†Ô∏è Change Failure Rate",
                  "value": "**${CHANGE_FAILURE_RATE}%**\n\`${CHANGE_FAILURE_RATE_CLASS} Performance\`",
                  "inline": true
                },
                {
                  "name": "\nüîß Time to Restore",
                  "value": "**${TTR_MIN} minutes**\n\`${TIME_TO_RESTORE_CLASS} Performance\`",
                  "inline": true
                }
              ],
              "url": "${WORKFLOW_URL}",
              "footer": {
                "text": "DORA Metrics Workflow ‚Ä¢ Click title to view workflow run history"
              },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"
