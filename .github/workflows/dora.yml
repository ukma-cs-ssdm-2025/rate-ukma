---
name: DORA Metrics

on:
  workflow_dispatch:
    inputs:
      pipeline-config-file:
        description: "Pipeline configuration file to evaluate"
        required: false
        type: string
        default: "main-pipeline.yml"
      limit:
        description: "Number of workflow runs to fetch"
        required: false
        type: string
        default: "100"

  schedule:
    - cron: "0 9 * * 2" # Every Tuesday at 09:00 UTC

jobs:
  dora-metrics:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Generate DORA Metrics and upload to repository
        working-directory: scripts/dora-metrics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PIPELINE_CONFIG_FILE: ${{ inputs.pipeline-config-file || 'main-pipeline.yml' }}
          LIMIT: ${{ inputs.limit || '100' }}
          RESULTS_DIR: results
          SCRIPT_FILE: generate_metrics.sh
        run: |
          mkdir -p "${{ env.RESULTS_DIR }}"
          chmod +x "${{ env.SCRIPT_FILE }}"

          ./${{ env.SCRIPT_FILE }} \
            --workflow "${{ env.PIPELINE_CONFIG_FILE }}" \
            --limit "${{ env.LIMIT }}"

      - name: Calculate Metrics and Generate Report
        id: calculate_metrics
        working-directory: scripts/dora-metrics
        env:
          CONFIG_FILE: ${{ inputs.pipeline-config-file || 'main-pipeline.yml' }}
          SCRIPT_FILE: generate_report.py # Placeholder for the script
          METRICS_FILE: results/metrics-raw.md
          DORA_SUMMARY_FILE: docs/ci-cd/dora-summary.md
          OUTPUT_FORMAT: github # Placeholder for the output format
        run: |
          chmod +x "${{ env.SCRIPT_FILE }}"
          python3 "${{ env.SCRIPT_FILE }}" "${{ env.METRICS_FILE }}" \
            ../../"${{ env.DORA_SUMMARY_FILE }}" \
            "${{ env.CONFIG_FILE }}" \
            | tee -a $GITHUB_STEP_SUMMARY

      - name: Commit and Push Report
        uses: EndBug/add-and-commit@v9.1.4
        env:
          DORA_SUMMARY_FILE: docs/ci-cd/dora-summary.md
        with:
          message: |
            docs(ci-cd): Update DORA metrics summary

            - Deployment Frequency: ${{ steps.calculate_metrics.outputs.deployment_frequency }}/week
            - Lead Time: ${{ steps.calculate_metrics.outputs.lead_time }} minutes
            - Change Failure Rate: ${{ steps.calculate_metrics.outputs.change_failure_rate }}%
            - Time to Restore: ${{ steps.calculate_metrics.outputs.time_to_restore }} minutes
            - Total runs analyzed: ${{ steps.calculate_metrics.outputs.total_runs }}

            Generated by DORA Metrics workflow [skip ci]
          add: ${{ env.DORA_SUMMARY_FILE }}
          default_author: github_actions
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DEPLOYMENT_FREQUENCY: ${{ steps.calculate_metrics.outputs.deployment_frequency }}
          LEAD_TIME: ${{ steps.calculate_metrics.outputs.lead_time }}
          CHANGE_FAILURE_RATE: ${{ steps.calculate_metrics.outputs.change_failure_rate }}
          TIME_TO_RESTORE: ${{ steps.calculate_metrics.outputs.time_to_restore }}
          TOTAL_RUNS: ${{ steps.calculate_metrics.outputs.total_runs }}
          WORKFLOW_NAME: ${{ inputs.pipeline-config-file || 'main-pipeline.yml' }}
          REPORT_URL: ${{ github.server_url }}/${{ github.repository }}/blob/main/docs/ci-cd/dora-summary.md
          JOB_STATUS: ${{ job.status }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "Discord webhook URL not configured, skipping notification"
            exit 0
          fi

          if [ "$JOB_STATUS" = "success" ]; then
            COLOR=3066993  # Green
            STATUS_EMOJI="✅"
          else
            COLOR=15158332  # Red
            STATUS_EMOJI="❌"
          fi

          LEAD_TIME_MIN=$(echo "$LEAD_TIME" | cut -d. -f1)
          TTR_MIN=$(echo "$TIME_TO_RESTORE" | cut -d. -f1)

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "${STATUS_EMOJI} DORA Metrics Report Updated",
              "description": "Weekly DORA metrics report has been generated and committed to the repository.",
              "color": ${COLOR},
              "fields": [
                {
                  "name": "-> Workflow",
                  "value": "`${WORKFLOW_NAME}`",
                  "inline": true
                },
                {
                  "name": "-> Deployment Frequency",
                  "value": "${DEPLOYMENT_FREQUENCY}/week",
                  "inline": true
                },
                {
                  "name": "-> Lead Time",
                  "value": "${LEAD_TIME_MIN} minutes",
                  "inline": true
                },
                {
                  "name": "-> Change Failure Rate",
                  "value": "${CHANGE_FAILURE_RATE}%",
                  "inline": true
                },
                {
                  "name": "-> Time to Restore",
                  "value": "${TTR_MIN} minutes",
                  "inline": true
                },
                {
                  "name": "-> Total Runs Analyzed",
                  "value": "${TOTAL_RUNS}",
                  "inline": true
                }
              ],
              "url": "${REPORT_URL}",
              "footer": {
                "text": "DORA Metrics Workflow"
              },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"
