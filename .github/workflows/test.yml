---
name: Tests
on:
  workflow_call:
    inputs:
      is_pr_run:
        description: "Indicates this run originated from a PR (from caller)"
        required: false
        type: boolean
        default: false
      deployment_ref:
        description: "Commit SHA, tag, or branch to test"
        required: false
        type: string
        default: ""
      backend_changed:
        description: "Whether backend code has changed"
        required: false
        type: boolean
        default: true
      webapp_changed:
        description: "Whether webapp code has changed"
        required: false
        type: boolean
        default: true

env:
  PYTHON_VERSION: "3.12"
  BACKEND_DIR: src/backend
  WEBAPP_DIR: src/webapp
  SRC_DIR: src
  BRANCH: ${{ inputs.deployment_ref || github.head_ref || github.ref_name }}
  COVERAGE_BADGE_FILE: coverage.svg
  BADGE_COMMIT_MESSAGE: "chore(ci): update coverage badge"

jobs:
  test-backend:
    if: inputs.backend_changed == true && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-24.04
    permissions:
      pull-requests: write
      contents: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ env.BRANCH }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Copy .env
        working-directory: ${{ env.SRC_DIR }}
        run: cp .env.sample .env

      - name: Install dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: uv sync --extra test

      - name: Run tests with pytest and coverage
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          uv run pytest --cov=. --cov-report=html --cov-report=xml --junitxml=junit.xml --cov-report=term-missing:skip-covered
          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 5 ]; then
              echo "No tests found. Exiting with 0."
              exit 0
          else
              exit $EXIT_CODE
          fi

      - name: Store coverage report
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            ${{ env.BACKEND_DIR }}/htmlcov
            ${{ env.BACKEND_DIR }}/coverage.xml
            ${{ env.BACKEND_DIR }}/junit.xml
          retention-days: 7

      - name: PR coverage comment
        if: success() && (github.event_name == 'pull_request' || github.event_name == 'workflow_run' || inputs.is_pr_run == true)
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-xml-coverage-path: ${{ env.BACKEND_DIR }}/coverage.xml
          junitxml-path: ${{ env.BACKEND_DIR }}/junit.xml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate coverage badge
        if: success() && github.ref != 'refs/heads/main'
        uses: tj-actions/coverage-badge-py@v2
        with:
          working-directory: ${{ env.BACKEND_DIR }}
          output: ${{ github.workspace }}/${{ env.COVERAGE_BADGE_FILE }}
          overwrite: true

      - name: Commit coverage badge to repo (current branch)
        if: success() && github.ref != 'refs/heads/main'
        uses: EndBug/add-and-commit@v9.1.4
        with:
          add: |
            ${{ env.COVERAGE_BADGE_FILE }}
          message: ${{ env.BADGE_COMMIT_MESSAGE }}
          default_author: github_actions
          github_token: ${{ secrets.GITHUB_TOKEN }}

  test-webapp:
    if: inputs.webapp_changed == true && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ env.BRANCH }}

      - name: Extract Node version from package.json
        id: versions
        working-directory: ${{ env.WEBAPP_DIR }}
        run: |
          NODE_VERSION=$(jq -r '.engines.node' package.json | sed 's/>=//')
          echo "node-version=$NODE_VERSION" >> $GITHUB_OUTPUT

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: ${{ env.WEBAPP_DIR }}/package.json
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.versions.outputs.node-version }}
          cache: "pnpm"
          cache-dependency-path: ${{ env.WEBAPP_DIR }}/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: ${{ env.WEBAPP_DIR }}
        run: pnpm install --frozen-lockfile

      - name: Run frontend unit tests
        working-directory: ${{ env.WEBAPP_DIR }}
        env:
          CI: true
        run: pnpm test
