---
name: Staging Build
on:
  workflow_dispatch:
    inputs:
      version-tag:
        description: "Version tag to deploy. Provide only for main branch deployments."
        required: false
        type: string
        default: ""
      deployment-ref:
        description: "Commit SHA, tag, or branch to run and deploy. Used for any branch deployments (e.g. feature branches)."
        required: false
        type: string
        default: ""
      base-ref:
        description: "Base ref for change detection when using deployment-ref"
        required: false
        type: string
        default: ""
  push:
    branches:
      - main
    paths:
      - src/**
      - .github/workflows/**

jobs:
  validate-refs:
    runs-on: ubuntu-24.04
    steps:
      - name: Validate version-tag usage
        run: |
          TARGET="${{ inputs.deployment-ref || github.ref_name }}"
          VERSION="${{ inputs.version-tag }}"

          if [ -n "$VERSION" ] && [ "$TARGET" != "main" ] && [ "$TARGET" != "refs/heads/main" ]; then
            echo "version-tag can be provided only for main branch deployments."
            exit 1
          fi

          if [ -z "$VERSION" ] && [ "$TARGET" = "main" ]; then
            echo "version-tag is required for manual main branch deployments."
            exit 1
          fi

          echo "Inputs validated for target: $TARGET with version-tag: ${VERSION:-<none>}"

  changes-filter:
    needs: validate-refs
    uses: ./.github/workflows/changes-filter.yml
    with:
      base: ${{ inputs.base-ref || (github.event.before != '' && github.event.before || 'origin/main') }}
      ref: ${{ inputs.deployment-ref || github.sha }}
      force_all_changed: ${{ github.event_name == 'workflow_dispatch' || inputs.version-tag != '' }}

  version:
    needs: changes-filter
    with:
      code_changed: >-
        ${{ inputs.version-tag == '' && inputs.deployment-ref == '' &&
        (fromJSON(needs.changes-filter.outputs.backend_changed) ||
        fromJSON(needs.changes-filter.outputs.webapp_changed)) }}
      manual_version_tag: ${{ inputs.version-tag || (inputs.deployment-ref != '' && format('dry-run-{0}', github.sha)) }}
    uses: ./.github/workflows/version.yml

  test:
    needs: changes-filter
    uses: ./.github/workflows/test.yml
    with:
      backend_changed: ${{ fromJSON(needs.changes-filter.outputs.backend_changed) || fromJSON(needs.changes-filter.outputs.ci_changed) }}
      webapp_changed: ${{ fromJSON(needs.changes-filter.outputs.webapp_changed) || fromJSON(needs.changes-filter.outputs.ci_changed) }}
      deployment_ref: ${{ inputs.deployment-ref || github.ref_name }}

  openapi-validation:
    needs: changes-filter
    with:
      api_changed: >-
        ${{ fromJSON(needs.changes-filter.outputs.backend_changed) ||
        fromJSON(needs.changes-filter.outputs.openapi_changed) }}
      deployment_ref: ${{ inputs.deployment-ref || github.ref_name }}
    uses: ./.github/workflows/openapi-validation.yml

  audit:
    needs: changes-filter
    uses: ./.github/workflows/audit.yml
    secrets: inherit
    with:
      run_backend_audit: ${{ fromJSON(needs.changes-filter.outputs.backend_changed) }}
      run_frontend_audit: ${{ fromJSON(needs.changes-filter.outputs.webapp_changed) }}
      deployment_ref: ${{ inputs.deployment-ref || github.ref_name }}

  build:
    needs: [version, test, openapi-validation, audit, changes-filter]
    if: |
      always() &&
      needs.version.result != 'failure' &&
      needs.test.result != 'failure' &&
      needs.openapi-validation.result != 'failure' &&
      needs.audit.result != 'failure' &&
      needs.changes-filter.result != 'failure'
    uses: ./.github/workflows/build.yml
    secrets: inherit
    with:
      version_tag: ${{ inputs.version-tag || needs.version.outputs.version_tag }}
      backend_changed: ${{ fromJSON(needs.changes-filter.outputs.backend_changed) || fromJSON(needs.changes-filter.outputs.ci_changed) }}
      webapp_changed: ${{ fromJSON(needs.changes-filter.outputs.webapp_changed) || fromJSON(needs.changes-filter.outputs.ci_changed) }}
      deployment_ref: ${{ inputs.deployment-ref || github.sha }}

  release-needed:
    needs: [version]
    if: inputs.version-tag == '' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-24.04
    outputs:
      release_needed: ${{ steps.check.outputs.release_needed }}
    env:
      VERSION_TAG: ${{ needs.version.outputs.version_tag }}
    steps:
      - uses: actions/checkout@v5

      - name: Check if release is needed
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view $VERSION_TAG; then
            RELEASE_NEEDED=false
          else
            RELEASE_NEEDED=true
          fi

          echo "release_needed=$RELEASE_NEEDED" >> $GITHUB_OUTPUT
          echo "Release needed: $RELEASE_NEEDED -> $VERSION_TAG"

  deploy-staging:
    needs: [version, build]
    if: always() && needs.build.result != 'failure'
    uses: ./.github/workflows/deploy-staging.yml
    with:
      deployment_ref: ${{ inputs.deployment-ref || github.sha }}
      version_tag: ${{ inputs.version-tag || needs.version.outputs.version_tag }}
    secrets:
      SSH_HOST: ${{ secrets.STAGING_SSH_HOST }}
      SSH_USER: ${{ secrets.STAGING_SSH_USER }}
      SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
      CORPORATE_EMAIL: ${{ secrets.CORPORATE_EMAIL }}
      CORPORATE_PASSWORD: ${{ secrets.CORPORATE_PASSWORD }}
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

  release:
    needs: [version, deploy-staging, release-needed]
    if: always() && needs.release-needed.result != 'failure' && needs.release-needed.outputs.release_needed == 'true'
    uses: ./.github/workflows/release.yml
    with:
      version_tag: ${{ needs.version.outputs.version_tag }}
      pre-release: true
