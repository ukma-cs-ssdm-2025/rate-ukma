name: Staging Build
on:
  push:
    branches:
      - main

jobs:
  version:
    uses: ./.github/workflows/version.yml

  test:
    uses: ./.github/workflows/test.yml

  openapi-validation:
    uses: ./.github/workflows/openapi-validation.yml

  audit:
    uses: ./.github/workflows/audit.yml
    secrets: inherit

  build:
    uses: ./.github/workflows/build.yml

  deploy-staging:
    needs: [version, test, openapi-validation, audit, build]
    uses: ./.github/workflows/deploy-staging.yml
    with:
      deployment_ref: ${{ needs.version.outputs.version_tag }}
    secrets:
      SSH_HOST: ${{ secrets.STAGING_SSH_HOST }}
      SSH_USER: ${{ secrets.STAGING_SSH_USER }}
      SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
