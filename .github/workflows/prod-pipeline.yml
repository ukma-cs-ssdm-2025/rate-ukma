---
name: Live Build

on:
  workflow_run:
    workflows: [Staging Build]
    types: [completed]
  workflow_dispatch:
    inputs:
      version_tag:
        description: "Version tag to deploy (e.g., v1.2.3)"
        required: true
        type: string

jobs:
  get-staging-released-version:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-24.04
    outputs:
      version_tag: ${{ steps.get_version.outputs.version_tag }}
      release_not_found: ${{ steps.get_version.outputs.release_not_found }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.version_tag || github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Get version from latest release
        id: get_version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION_TAG="${{ inputs.version_tag }}"
            echo "Using manual version: $VERSION_TAG"
          else
            COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
            VERSION_TAG=$(git tag --points-at $COMMIT_SHA | grep '^v' | head -n 1)

            if [[ -z "$VERSION_TAG" ]]; then
              echo "No version tag found for commit $COMMIT_SHA"
              echo "Staging build ran without creating a new version, skipping deployment"
              echo "release_not_found=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "Staging version: $VERSION_TAG"
          fi

          if ! gh release view "$VERSION_TAG" >/dev/null 2>&1; then
            echo "Release $VERSION_TAG not found"
            echo "release_not_found=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "version_tag=$VERSION_TAG" >> "$GITHUB_OUTPUT"
          echo "release_not_found=false" >> "$GITHUB_OUTPUT"

  get-latest-live-tag:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-24.04
    outputs:
      latest_live_tag: ${{ steps.get_latest.outputs.latest_live_tag }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get Latest Live Tag
        id: get_latest
        env:
          LIVE_TAG_PREFIX: "live-"
        run: |
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"
          git fetch --tags
          LATEST_LIVE_TAG=$(git tag -l "$LIVE_TAG_PREFIX*" --sort=-v:refname | head -n 1)

          if [[ -z "$LATEST_LIVE_TAG" ]]; then
            echo "No live tags found, using main as base"
            echo "latest_live_tag=main" >> "$GITHUB_OUTPUT"
          else
            echo "Latest live tag: $LATEST_LIVE_TAG"
            echo "latest_live_tag=$LATEST_LIVE_TAG" >> "$GITHUB_OUTPUT"
          fi

  deploy-live:
    if: needs.get-staging-released-version.result == 'success' && needs.get-staging-released-version.outputs.release_not_found != 'true'
    uses: ./.github/workflows/deploy.yml
    needs: [get-staging-released-version]
    with:
      environment: live
      deployment_ref: ${{ needs.get-staging-released-version.outputs.version_tag }}
      version_tag: ${{ needs.get-staging-released-version.outputs.version_tag }}
      test_url: ${{ vars.LIVE_URL }}
      run_e2e_tests: true
    secrets:
      SSH_HOST: ${{ secrets.LIVE_SSH_HOST }}
      SSH_USER: ${{ secrets.LIVE_SSH_USER }}
      SSH_KEY: ${{ secrets.LIVE_SSH_KEY }}
      CORPORATE_EMAIL: ${{ secrets.CORPORATE_EMAIL }}
      CORPORATE_PASSWORD: ${{ secrets.CORPORATE_PASSWORD }}
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

  update_pre_releases:
    if: needs.get-staging-released-version.result == 'success' && needs.get-staging-released-version.outputs.release_not_found != 'true'
    needs: [get-latest-live-tag, get-staging-released-version, deploy-live]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.get-staging-released-version.outputs.version_tag }}
          fetch-depth: 0

      - name: Fetch Tags
        run: |
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"
          git fetch --tags

      - name: Get all releases between last live and current
        id: get_releases
        env:
          PREV_LIVE_TAG: ${{ needs.get-latest-live-tag.outputs.latest_live_tag }}
          VERSION_TAG: "${{ needs.get-staging-released-version.outputs.version_tag }}"
          LIVE_TAG_PREFIX: "live-"
        run: |
          LAST_TAG=${PREV_LIVE_TAG#$LIVE_TAG_PREFIX}
          CURRENT_TAG=$VERSION_TAG

          RELEASES_TO_UPDATE=$(git log --pretty=format:"%D" $LAST_TAG..$CURRENT_TAG | \
            grep -oE 'tag: [^,)]+' | sed 's/tag: //' | grep '^v' | sort -uV)

          echo "Releases to update: $RELEASES_TO_UPDATE"

          {
            echo "tags<<EOF"
            echo "$RELEASES_TO_UPDATE"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Update Pre Releases
        id: update_pre_releases
        if: steps.get_releases.outputs.tags != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          readarray -t tags <<< "${{ steps.get_releases.outputs.tags }}"
          echo "Processing releases: ${tags[@]}"

          LAST_INDEX=$(( ${#tags[@]} - 1 ))

          for i in "${!tags[@]}"; do
            tag="${tags[$i]}"
            echo "Updating release: $tag"

            if [[ "$i" -eq "$LAST_INDEX" ]]; then
              LATEST_FLAG="--latest"
            else
              LATEST_FLAG="--latest=false"
            fi

            if ! gh release edit "$tag" --prerelease=false "$LATEST_FLAG" > /dev/null 2>&1; then
              echo "No GitHub Release found for tag '$tag'. Skipping..." >&2
              continue
            fi

            echo "Successfully updated release: $tag"
          done

  push_live_tag:
    if: needs.get-staging-released-version.result == 'success' && needs.get-staging-released-version.outputs.release_not_found != 'true'
    needs: [get-staging-released-version, update_pre_releases]
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.get-staging-released-version.outputs.version_tag }}
          fetch-depth: 0

      - name: Push Live Version Tag
        id: push_live_tag
        env:
          LIVE_VERSION_TAG: "live-${{ needs.get-staging-released-version.outputs.version_tag }}"
        run: |
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git tag -l | grep -q "^${LIVE_VERSION_TAG}$"; then
            echo "Tag ${LIVE_VERSION_TAG} already exists. Skipping tag creation and pushing."
            exit 0
          fi

          echo "Creating and pushing tag ${LIVE_VERSION_TAG}"

          if ! git tag $LIVE_VERSION_TAG; then
            echo "::warning::Failed to create tag ${LIVE_VERSION_TAG}"
            exit 1
          fi

          if ! git push origin $LIVE_VERSION_TAG 2>&1; then
            echo "::warning::Failed to push tag ${LIVE_VERSION_TAG}. This may be due to workflow file permissions."
            echo "::notice::Tag ${LIVE_VERSION_TAG} was created locally but not pushed to remote."
            echo "::notice::This is expected when the commit contains workflow file changes and GITHUB_TOKEN lacks sufficient permissions."
            echo "::notice::Fine-grained PAT from an organization admin is required for this action to work."
            echo "::notice::The deployment completed successfully despite this."

            exit 0
          fi

          echo "::notice::Tag ${LIVE_VERSION_TAG} created and pushed successfully"
