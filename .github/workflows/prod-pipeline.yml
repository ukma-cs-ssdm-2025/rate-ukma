name: Live Build
on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: "Version tag to deploy (e.g., v1.2.3)"
        required: true
        type: string

jobs:
  test:
    uses: ./.github/workflows/test.yml

  openapi-validation:
    uses: ./.github/workflows/openapi-validation.yml

  audit:
    uses: ./.github/workflows/audit.yml
    secrets: inherit

  build:
    uses: ./.github/workflows/build.yml

  deploy-live:
    needs: [test, openapi-validation, audit, build]
    uses: ./.github/workflows/deploy-live.yml
    with:
      deployment_ref: ${{ inputs.version_tag }}
    secrets:
      SSH_HOST: ${{ secrets.LIVE_SSH_HOST }}
      SSH_USER: ${{ secrets.LIVE_SSH_USER }}
      SSH_KEY: ${{ secrets.LIVE_SSH_KEY }}

  create_release:
    needs: deploy-live
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.version_tag }}
          fetch-depth: 0

      - name: Set Live Version Tag
        id: set_live_version_tag
        env:
          LIVE_VERSION_TAG: "live-${{inputs.version_tag}}"
        run: |
          echo "LIVE_VERSION_TAG=$LIVE_VERSION_TAG" >> "$GITHUB_OUTPUT"

      - name: Get Previous Live Release
        id: prev_release
        env:
          LIVE_TAG_PREFIX: "live-"
          MAIN_VERSION_TAG: ${{inputs.version_tag}}
        run: |
          PREV_TAG=$(git tag -l "$LIVE_TAG_PREFIX*" --sort=-v:refname | head -n 1)
          echo "prev_tag=$PREV_TAG" >> "$GITHUB_OUTPUT"

          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%an)" "$PREV_TAG".."$MAIN_VERSION_TAG")

            if [ -n "$COMMITS" ]; then
              CHANGELOG="$COMMITS"
            else
              CHANGELOG="No changes since last live release"
            fi
            
          else
            CHANGELOG="No previous live release"
          fi

          echo "changelog<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGELOG" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create Version Tag
        id: create_version_tag
        env:
          LIVE_VERSION_TAG: "live-${{inputs.version_tag}}"
        run: |
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"
          git tag $LIVE_VERSION_TAG
          git push origin $LIVE_VERSION_TAG

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          MAIN_VERSION_TAG: ${{inputs.version_tag}}
          LIVE_VERSION_TAG: "live-${{inputs.version_tag}}"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "live-${{inputs.version_tag}}"
          name: "Live Release ${{ inputs.version_tag }}"
          body: |
            Latest stable version: `$MAIN_VERSION_TAG`
            Live tag: $LIVE_VERSION_TAG
            Previous live version: `${{ steps.prev_release.outputs.prev_tag }}`

            ## Changelog since last release:
            ${{ steps.prev_release.outputs.changelog }}

            [View changes](${{ github.server_url }}/${{ github.repository }}/compare/${{ steps.prev_release.outputs.prev_tag }}...$LIVE_VERSION_TAG)

          draft: false
          prerelease: false
