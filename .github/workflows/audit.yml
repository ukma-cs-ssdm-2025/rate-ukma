---
name: Security Audit

on:
  workflow_call:
    inputs:
      run_frontend_audit:
        description: "Run the frontend security audit job"
        required: false
        type: boolean
        default: true
      run_backend_audit:
        description: "Run the backend security audit job"
        required: false
        type: boolean
        default: true
  schedule:
    - cron: "0 6 * * *" # Daily at 06:00 UTC

permissions:
  contents: read
  security-events: write

concurrency:
  group: security-audit-${{ github.ref }}

env:
  FRONTEND_DIR: src/webapp
  BACKEND_DIR: src/backend

jobs:
  frontend-security-audit:
    name: Frontend Security Audit
    if: inputs.run_frontend_audit == true
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js & pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          working-directory: ${{ env.FRONTEND_DIR }}

      - name: pnpm audit high severity
        working-directory: ${{ env.FRONTEND_DIR }}
        run: pnpm run security:audit

      - name: Snyk test (SARIF upload)
        uses: snyk/actions/node@master
        with:
          command: test
          args: ${{ env.FRONTEND_DIR }} --sarif-file-output=${{ env.FRONTEND_DIR }}/snyk.sarif --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      - name: Upload Snyk SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ env.FRONTEND_DIR }}/snyk.sarif
          category: snyk

  backend-security-audit:
    name: Backend Security Audit
    if: inputs.run_backend_audit == true
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v5

      - name: Setup Python & uv
        uses: ./.github/actions/setup-python-uv
        with:
          working-directory: ${{ env.BACKEND_DIR }}

      - name: Install dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: uv sync --extra security

      - name: Safety check
        id: safety_check
        uses: pyupio/safety-action@v1
        with:
          api-key: ${{ secrets.SAFETY_API_KEY }}
        env:
          ACTIONS_STEP_DEBUG: true
        continue-on-error: true

      - name: Bandit security scan
        working-directory: ${{ env.BACKEND_DIR }}
        run: uv run bandit -c pyproject.toml -r . --severity-level high --confidence-level high -f sarif -o bandit-results.sarif
        continue-on-error: true

      - name: Upload Bandit SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ env.BACKEND_DIR }}/bandit-results.sarif
          category: bandit
